



<!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
        <link rel="canonical" href="https://nus-cs2030.github.io/1718-s2/lec08/index.html">
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-0.17.5, mkdocs-material-2.9.2">
    
    
      
        <title>8. Streams - CS2030 Programming Methodology II</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.ba0fd1a6.css">
      
      
    
    
      <script src="../assets/javascripts/modernizr.1aa3b519.js"></script>
    
    
      <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
      
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
      <link rel="stylesheet" href="../stylesheets/extra.css">
    
      <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Gentium+Book+Basic">
    
      <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto">
    
      <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.1/css/font-awesome.min.css">
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448"
    viewBox="0 0 416 448" id="__github">
  <path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19-18.125
        8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19 18.125-8.5
        18.125 8.5 10.75 19 3.125 20.5zM320 304q0 10-3.125 20.5t-10.75
        19-18.125 8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19
        18.125-8.5 18.125 8.5 10.75 19 3.125 20.5zM360
        304q0-30-17.25-51t-46.75-21q-10.25 0-48.75 5.25-17.75 2.75-39.25
        2.75t-39.25-2.75q-38-5.25-48.75-5.25-29.5 0-46.75 21t-17.25 51q0 22 8
        38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0
        37.25-1.75t35-7.375 30.5-15 20.25-25.75 8-38.375zM416 260q0 51.75-15.25
        82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5-41.75
        1.125q-19.5 0-35.5-0.75t-36.875-3.125-38.125-7.5-34.25-12.875-30.25-20.25-21.5-28.75q-15.5-30.75-15.5-82.75
        0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25
        30.875q36.75-8.75 77.25-8.75 37 0 70 8 26.25-20.5
        46.75-30.25t47.25-9.75q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34
        99.5z" />
</svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#lecture-8-lambdas-and-streams" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="https://nus-cs2030.github.io/1718-s2" title="CS2030 Programming Methodology II" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            
              <span class="md-header-nav__topic">
                CS2030 Programming Methodology II
              </span>
              <span class="md-header-nav__topic">
                8. Streams
              </span>
            
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          
            <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
            
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
          
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  


  <a href="https://github.com/nus-cs2030/1718-s2/" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#__github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      GitHub
    </div>
  </a>

          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <span class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </span>
    CS2030 Programming Methodology II
  </label>
  
    <div class="md-nav__source">
      


  


  <a href="https://github.com/nus-cs2030/1718-s2/" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#__github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      GitHub
    </div>
  </a>

    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../index.html" title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      General
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        General
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../about/index.html" title="About" class="md-nav__link">
      About
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../prereqs/index.html" title="Prerequisites" class="md-nav__link">
      Prerequisites
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../policies/index.html" title="Policies" class="md-nav__link">
      Policies
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../schedule/index.html" title="Schedule" class="md-nav__link">
      Schedule
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../readings/index.html" title="Readings" class="md-nav__link">
      Readings
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../final/index.html" title="Final" class="md-nav__link">
      Final
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../midterm/index.html" title="Midterm" class="md-nav__link">
      Midterm
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7" type="checkbox" id="nav-7">
    
    <label class="md-nav__link" for="nav-7">
      Labs
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-7">
        Labs
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../lab0/index.html" title="0. Warm Up" class="md-nav__link">
      0. Warm Up
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../lab1a/index.html" title="1a. Simulator v1.0" class="md-nav__link">
      1a. Simulator v1.0
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../lab1b/index.html" title="1b. Simulator v1.1" class="md-nav__link">
      1b. Simulator v1.1
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../lab2a/index.html" title="2a. Simulator v1.2" class="md-nav__link">
      2a. Simulator v1.2
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../lab2b/index.html" title="2b. Simulator v1.3" class="md-nav__link">
      2b. Simulator v1.3
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../lab3/index.html" title="3.  Infinite List" class="md-nav__link">
      3.  Infinite List
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../lab4a/index.html" title="4a. Simulator v2.0" class="md-nav__link">
      4a. Simulator v2.0
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../lab4b/index.html" title="4b. Simulator v2.1" class="md-nav__link">
      4b. Simulator v2.1
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../lab5/index.html" title="5.  Matrix Multiplication" class="md-nav__link">
      5.  Matrix Multiplication
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../lab6/index.html" title="6.  Async Web API" class="md-nav__link">
      6.  Async Web API
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-8" type="checkbox" id="nav-8" checked>
    
    <label class="md-nav__link" for="nav-8">
      Lectures
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-8">
        Lectures
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../lec01/index.html" title="1. Abstraction & Encapsulation" class="md-nav__link">
      1. Abstraction & Encapsulation
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../lec02/index.html" title="2. Interface, Inheritance & Polymorphism" class="md-nav__link">
      2. Interface, Inheritance & Polymorphism
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../lec03/index.html" title="3. More on Inheritance" class="md-nav__link">
      3. More on Inheritance
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../lec04/index.html" title="4. Types, Memory, Exception" class="md-nav__link">
      4. Types, Memory, Exception
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../lec05/index.html" title="5. Generics and Collections" class="md-nav__link">
      5. Generics and Collections
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../lec06/index.html" title="6. hashCode, Nested Class, enum" class="md-nav__link">
      6. hashCode, Nested Class, enum
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../lec07/index.html" title="7. Functions" class="md-nav__link">
      7. Functions
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        8. Streams
      </label>
    
    <a href="index.html" title="8. Streams" class="md-nav__link md-nav__link--active">
      8. Streams
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#learning-objectives" title="Learning Objectives" class="md-nav__link">
    Learning Objectives
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#lambda-as-closure" title="Lambda as Closure" class="md-nav__link">
    Lambda as Closure
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#function-as-cross-barrier-state-manipulator" title="Function as Cross-Barrier State Manipulator" class="md-nav__link">
    Function as Cross-Barrier State Manipulator
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#optional" title="Optional" class="md-nav__link">
    Optional
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#initializing-an-optional" title="Initializing an Optional" class="md-nav__link">
    Initializing an Optional
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#function-as-delayed-data" title="Function as Delayed Data" class="md-nav__link">
    Function as Delayed Data
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#an-infinite-list" title="An Infinite List" class="md-nav__link">
    An Infinite List
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#stream" title="Stream" class="md-nav__link">
    Stream
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#stream-operations" title="Stream Operations" class="md-nav__link">
    Stream Operations
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-is-this-a-prime" title="Example: Is this a prime?" class="md-nav__link">
    Example: Is this a prime?
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#exercise" title="Exercise" class="md-nav__link">
    Exercise
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../lec09/index.html" title="9. FP Patterns" class="md-nav__link">
      9. FP Patterns
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../lec10/index.html" title="10. Parallel streams" class="md-nav__link">
      10. Parallel streams
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../lec11/index.html" title="11. Asynchronous" class="md-nav__link">
      11. Asynchronous
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../monad/index.html" title="Extra. Build a Monad" class="md-nav__link">
      Extra. Build a Monad
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../review-questions/index.html" title="Extra. Review Questions" class="md-nav__link">
      Extra. Review Questions
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../style/index.html" title="Coding Style" class="md-nav__link">
      Coding Style
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-10" type="checkbox" id="nav-10">
    
    <label class="md-nav__link" for="nav-10">
      Software/Tools
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-10">
        Software/Tools
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../jdk/index.html" title="Java" class="md-nav__link">
      Java
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../javadoc/index.html" title="Javadoc" class="md-nav__link">
      Javadoc
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../unix/index.html" title="UNIX" class="md-nav__link">
      UNIX
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../vim/index.html" title="Vim" class="md-nav__link">
      Vim
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#learning-objectives" title="Learning Objectives" class="md-nav__link">
    Learning Objectives
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#lambda-as-closure" title="Lambda as Closure" class="md-nav__link">
    Lambda as Closure
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#function-as-cross-barrier-state-manipulator" title="Function as Cross-Barrier State Manipulator" class="md-nav__link">
    Function as Cross-Barrier State Manipulator
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#optional" title="Optional" class="md-nav__link">
    Optional
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#initializing-an-optional" title="Initializing an Optional" class="md-nav__link">
    Initializing an Optional
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#function-as-delayed-data" title="Function as Delayed Data" class="md-nav__link">
    Function as Delayed Data
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#an-infinite-list" title="An Infinite List" class="md-nav__link">
    An Infinite List
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#stream" title="Stream" class="md-nav__link">
    Stream
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#stream-operations" title="Stream Operations" class="md-nav__link">
    Stream Operations
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-is-this-a-prime" title="Example: Is this a prime?" class="md-nav__link">
    Example: Is this a prime?
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#exercise" title="Exercise" class="md-nav__link">
    Exercise
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/nus-cs2030/1718-s2/edit/master/docs/lec08.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="lecture-8-lambdas-and-streams">Lecture 8: Lambdas and Streams</h1>
<h2 id="learning-objectives">Learning Objectives</h2>
<p>After this lecture, students should be familiar with:</p>
<ul>
<li>the concept of closure and its relation to lambda expressions</li>
<li>the concept of eager evaluation vs. lazy evaluation</li>
<li>Java <code class="codehilite">Optional</code> class and its operations</li>
<li>the concept of function as delayed data and its application in defining an infinite list</li>
<li>Java <code class="codehilite">Stream</code> class and its operations</li>
<li>using the stream operations to write declarative-style code, avoiding loops and branches</li>
</ul>
<p>We continue where we left off in Lecture 7.</p>
<h3 id="lambda-as-closure">Lambda as Closure</h3>
<p>Just like a local class and an anonymous class, a lambda expression can capture the variables of the enclosing scope.  Recall that, a lambda expression is just a shorthand to an anonymous class after all.  </p>
<p>For instance, if you do not wish to generate the service time of a customer at the time of arrival, you can pass in a <code class="codehilite">Supplier</code> to <code class="codehilite">Customer</code> instead:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>Customer c = new Customer(() -&gt; rng.GenServiceTime());
</pre></div>
</td></tr></table></p>
<p>Here, <code class="codehilite">rng</code> is a variable captured from the enclosing scope.</p>
<p>Just like in local and anonymous classes, a captured variable must be either explicitly declared as <code class="codehilite">final</code> or is effectively final.</p>
<p>A lambda expression, therefore, stores more than just the function to invoke -- it also stores the data from the environment where it is defined.  We call such construct that stores a function together with the enclosing environment a <em>closure</em>. </p>
<h2 id="function-as-cross-barrier-state-manipulator">Function as Cross-Barrier State Manipulator</h2>
<p>We have seen that functional-style programming allow us to do a few things that we couldn't before with functions: (i) we can assign function to a variable, pass functions around, return it from another function; (ii) we can compose and create functions dynamically during runtime; (iii) we can partially evaluate a function.</p>
<p>Let's take a look at two ways functional-style programming helps us write better programs.</p>
<p>We have seen the <code class="codehilite">applyList</code> method last week, where we pass a <code class="codehilite">Function&lt;T,R&gt;</code> object to manipulate the items in the list.  This method, commonly known as <code class="codehilite">map</code>, saves us from writing loops and leads to shorter and less buggy code.  If we view the internal representation of the list of items as behind the abstraction barrier, then we are manipulating data behind the abstraction barrier without knowing the internals of the object -- something we could only do through the interfaces provided by the implementer earlier, before the introduction of functions.</p>
<h2 id="optional"><code class="codehilite">Optional</code></h2>
<p>Another way passing in functions to manipulate internal data is helpful is the <a href="https://docs.oracle.com/javase/8/ docs/api/java/util/Optional.html"><code class="codehilite">Optional&lt;T&gt;</code></a> class.  <code class="codehilite">Optional&lt;T&gt;</code> is a wrapper around a reference to either a <code class="codehilite">T</code> object or a <code class="codehilite">null</code>.  Recall that we said bugs can occur if we write functions that return a value not in its codomain, and we gave <code class="codehilite">null</code> as an example.  Often, we write functions that return <code class="codehilite">null</code> to indicate a special situation (e.g., <code class="codehilite">server = shop.findIdleServer()</code> cannot find an idle server) but use the returned reference without checking for <code class="codehilite">null</code> (e.g., <code class="codehilite">server.serve(customer)</code>) leading to <code class="codehilite">NullPointerException</code> being raised, because <code class="codehilite">null</code> is not a Server object.</p>
<p>Wrapping the returned reference with an <code class="codehilite">Optional</code> changes the codomain of the function written, as <code class="codehilite">null</code> is now explicitly in the codomain.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">Server</span><span class="o">&gt;</span> <span class="n">server</span> <span class="o">=</span> <span class="n">shop</span><span class="o">.</span><span class="na">findIdleServer</span><span class="o">();</span>
</pre></div>
</td></tr></table>

<p>We now have a reference to an <code class="codehilite">Optional</code> object, which wraps around either a server or <code class="codehilite">null</code>.  We cannot call <code class="codehilite">server.serve(customer)</code> since the actual reference to the server is behind the abstraction barrier.  The <code class="codehilite">Optional</code> class provides a method <code class="codehilite">ifPresent</code> that takes in a <code class="codehilite">Consumer</code>.  So you can call:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="n">server</span><span class="o">.</span><span class="na">ifPresent</span><span class="o">(</span><span class="n">s</span> <span class="o">-&gt;</span> <span class="n">s</span><span class="o">.</span><span class="na">serve</span><span class="o">(</span><span class="n">customer</span><span class="o">))</span>
</pre></div>
</td></tr></table>

<p>If server wraps around <code class="codehilite">null</code>, then <code class="codehilite">ifPresent</code> do nothing.  Using <code class="codehilite">Optional</code> means that we no longer have to write branching statements:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>   <span class="n">server</span> <span class="o">=</span> <span class="n">shop</span><span class="o">.</span><span class="na">findIdleServer</span><span class="o">();</span>
   <span class="k">if</span> <span class="o">(</span><span class="n">server</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span> 
     <span class="n">server</span><span class="o">.</span><span class="na">serve</span><span class="o">(</span><span class="n">customer</span><span class="o">);</span>
   <span class="o">}</span>
</pre></div>
</td></tr></table></p>
<p>It can makes code with multiple-level of branching clearer.  Without <code class="codehilite">Optional</code>,</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>   <span class="n">server</span> <span class="o">=</span> <span class="n">shop</span><span class="o">.</span><span class="na">findIdleServer</span><span class="o">();</span>
   <span class="k">if</span> <span class="o">(</span><span class="n">server</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span> 
     <span class="n">server</span> <span class="o">=</span> <span class="n">shop</span><span class="o">.</span><span class="na">findShortestQueue</span><span class="o">();</span>
     <span class="k">if</span> <span class="o">(</span><span class="n">server</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">customer</span><span class="o">.</span><span class="na">leave</span><span class="o">();</span>
     <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="n">server</span><span class="o">.</span><span class="na">serve</span><span class="o">(</span><span class="n">customer</span><span class="o">);</span>
     <span class="o">}</span>
   <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
     <span class="n">server</span><span class="o">.</span><span class="na">serve</span><span class="o">(</span><span class="n">customer</span><span class="o">);</span>
   <span class="o">}</span>
</pre></div>
</td></tr></table>

<p>Using <code class="codehilite">Optional</code>, we write</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="n">shop</span><span class="o">.</span><span class="na">findIdleServer</span><span class="o">()</span>
    <span class="o">.</span><span class="na">or</span><span class="o">(</span><span class="n">shop</span><span class="o">::</span><span class="n">findShortestQueue</span><span class="o">)</span>
    <span class="o">.</span><span class="na">ifPresentOrElse</span><span class="o">(</span>
        <span class="n">s</span> <span class="o">-&gt;</span> <span class="n">s</span><span class="o">.</span><span class="na">serve</span><span class="o">(</span><span class="n">customer</span><span class="o">),</span>
        <span class="n">customer</span><span class="o">::</span><span class="n">leave</span><span class="o">);</span>
</pre></div>
</td></tr></table>

<div class="admonition notes">
<p class="admonition-title">Java 8 vs. 9</p>
<p><code class="codehilite">or</code> and <code class="codehilite">ifPresentOrElse</code> are available in Java 9 only.</p>
</div>
<p>The branching logic still exists, but is internalized, just like we have internalized loops with <code class="codehilite">applyList</code> method.  Furthermore, we do not explicitly compares with <code class="codehilite">null</code> anymore and this code will never raise a <code class="codehilite">NullPointerException</code>.</p>
<div class="admonition warning">
<p class="admonition-title">Updated Notes</p>
<p>This whole section is more or less rewritten since published.  If you print your notes, please make sure that you have the latest version.</p>
</div>
<h3 id="initializing-an-optional">Initializing an <code class="codehilite">Optional</code></h3>
<p>To wrap up the discussion, let's see how we can create an <code class="codehilite">Optional</code> object.  If you want to wrap a non-<code class="codehilite">null</code> value in an <code class="codehilite">Optional</code>, call <code class="codehilite">Optional.of(value)</code>.  Otherwise, if you want to wrap it in a <code class="codehilite">null</code>, call <code class="codehilite">Optional.empty()</code>.  </p>
<p>Alternatively, if you do not want to check if the value is <code class="codehilite">null</code> or not, call <code class="codehilite">Optional.ofNullable(value)</code> which will return one of the above appropriately for you.</p>
<div class="admonition note">
<p class="admonition-title"><code class="codehilite">Optional</code> In other languages</p>
<p>Scala has <code class="codehilite">Option</code>; Haskell has <code class="codehilite">Maybe</code>. If you use Python, check out the <code class="codehilite">PyMonad</code> library that supplies a <code class="codehilite">Maybe</code> class.</p>
</div>
<h2 id="function-as-delayed-data">Function as Delayed Data</h2>
<p>Consider a function that produces a new value or values.  We can consider the function as a promise to provide us the given data sometime later, when needed.  For instance:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>() -&gt; rng.genServiceTime()
</pre></div>
</td></tr></table></p>
<p>is not the value of a service time, but rather, a supplier of the service time.  We invoke this supplier only when we need the service time.</p>
<p>Consider the case where the function to generate data is an expensive one.  We can delay the execution of the expensive function until it is absolutely needed.  This is called <em>lazy evaluation</em>.  </p>
<h3 id="an-infinite-list">An Infinite List</h3>
<p>Lazy evaluation allows us to build data structures that we could not before.  For instance, we can create and manipulate a list that is infinitely long.</p>
<p>How can we represent and manipulate an infinitely long list?  If we store the values of each element in the list, then we will run out of memory pretty soon.  If we try to manipulate every element in the list, then we will enter an infinite loop.  </p>
<p>The trick to building an infinite list, is to treat the elements in the list as <em>delayed data</em>, and store <em>a function that generates the elements</em>, instead of the elements themselves.</p>
<p>We can think of an infinite list as consisting of two functions, the first is a function that generates the first element, and the second is a function that generates the rest of the list.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kd">class</span> <span class="nc">InfiniteList</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="n">Supplier</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">headSupplier</span><span class="o">;</span>
  <span class="kd">private</span> <span class="n">Supplier</span><span class="o">&lt;</span><span class="n">InfiniteList</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span> <span class="n">tailSupplier</span><span class="o">;</span>

  <span class="kd">public</span> <span class="nf">InfiniteList</span><span class="o">(</span><span class="n">Supplier</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">headSupplier</span><span class="o">,</span> <span class="n">Supplier</span><span class="o">&lt;</span><span class="n">InfiniteList</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span> <span class="n">tailSupplier</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">headSupplier</span> <span class="o">=</span> <span class="n">headSupplier</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">tailSupplier</span> <span class="o">=</span> <span class="n">tailSupplier</span><span class="o">;</span>
  <span class="o">}</span>

    <span class="o">:</span>
<span class="o">}</span>
</pre></div>
</td></tr></table>

<p>We can then construct an infinite list in different ways by passing in different suppliers.</p>
<p>Suppose we want every element in the list to be generated using the same supplier.  We can write a method that does as follows:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>  <span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">InfiniteList</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="nf">generate</span><span class="o">(</span><span class="n">Supplier</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">supply</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">InfiniteList</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;(</span><span class="n">supply</span><span class="o">,</span>
        <span class="o">()</span> <span class="o">-&gt;</span> <span class="n">InfiniteList</span><span class="o">.</span><span class="na">generate</span><span class="o">(</span><span class="n">supply</span><span class="o">));</span>
  <span class="o">}</span>
</pre></div>
</td></tr></table>

<p>Or we can construct an infinite list consisting of a sequence of elements, each computed from the previous element using a <code class="codehilite">next</code> function:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>  <span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">InfiniteList</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="nf">iterate</span><span class="o">(</span><span class="n">T</span> <span class="n">init</span><span class="o">,</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">T</span><span class="o">,</span> <span class="n">T</span><span class="o">&gt;</span> <span class="n">next</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">InfiniteList</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;(()</span> <span class="o">-&gt;</span> <span class="n">init</span><span class="o">,</span>
      <span class="o">()</span> <span class="o">-&gt;</span> <span class="n">InfiniteList</span><span class="o">.</span><span class="na">iterate</span><span class="o">(</span><span class="n">next</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="n">init</span><span class="o">),</span> <span class="n">next</span><span class="o">));</span>
  <span class="o">}</span>
</pre></div>
</td></tr></table>

<p>Here are some examples of how to use the two methods above:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="n">InfiniteList</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">ones</span> <span class="o">=</span> <span class="n">InfiniteList</span><span class="o">.</span><span class="na">generate</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="mi">1</span><span class="o">);</span> <span class="c1">// 1, 1, 1, 1, ....</span>
<span class="n">InfiniteList</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">even</span> <span class="o">=</span> <span class="n">InfiniteList</span><span class="o">.</span><span class="na">iterate</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">2</span><span class="o">);</span> <span class="c1">// 0, 2, 4, 6, ...</span>
</pre></div>
</td></tr></table>

<p>A list that is defined this way is lazily evaluated.  We will not call the supplier to generate the elements until we need it -- this is in contrast to the eagerly evaluate <code class="codehilite">LambdaList</code> from the exercise in Lecture 7.</p>
<p>Let's see how we can manipulate this list.  Consider the <code class="codehilite">findFirst</code> method, which returns the first element in the list that satisfies the given predicate.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kd">public</span> <span class="n">T</span> <span class="nf">findFirst</span><span class="o">(</span><span class="n">Predicate</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">predicate</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">InfiniteList</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">list</span> <span class="o">=</span> <span class="k">this</span><span class="o">;</span>
  <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">T</span> <span class="n">next</span> <span class="o">=</span> <span class="n">list</span><span class="o">.</span><span class="na">headSupplier</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">predicate</span><span class="o">.</span><span class="na">test</span><span class="o">(</span><span class="n">next</span><span class="o">))</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">next</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="n">list</span> <span class="o">=</span> <span class="n">list</span><span class="o">.</span><span class="na">tailSupplier</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</td></tr></table>

<p>In the method above, we repeatedly invoke the supplier, until we find an element that matches the predicate.  This way, we never had to generate every element in the list just to find the first element that matches.</p>
<h2 id="stream">Stream</h2>
<p>Such a list, possibly infinite, that is lazily evaluated on demand is also known as a <em>stream</em>.  Java 8 provides a class <code class="codehilite">Stream</code> and a set of useful and powerful methods on streams, allowing programmers to manipulate data very easily.  Java 9 adds a couple of useful methods, <code class="codehilite">takeWhile</code> and <code class="codehilite">dropWhile</code>, which is also invaluable.  To take full advantage of streams, we will be using Java 9, not Java 8 for the rest of this class.  </p>
<h3 id="stream-operations">Stream Operations</h3>
<p>A few things to note before I show you how to use streams.  First, the operations on streams can be classified as either <em>intermediate</em> or <em>terminal</em>.  An <em>intermediate</em> operation returns another stream.  For instance, <code class="codehilite">map</code>, <code class="codehilite">filter</code>, <code class="codehilite">peek</code> are examples of intermediate operations.  An intermediate operation does not cause the stream to be evaluated.  A terminal operation, on the other hand, forces the streams to be evaluated.  It does not return a stream.  <code class="codehilite">reduce</code>, <code class="codehilite">findFirst</code>, <code class="codehilite">forEach</code> are examples of terminal operation.  A typical way of writing code that operates on streams is to chain a series of intermediate operation together, ending with a terminal operation.  </p>
<p>Second, a stream can only be consumed once.  We cannot iterate through a stream multiple times.  We have to create the stream again if we want to do that:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="n">Stream</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">s</span> <span class="o">=</span> <span class="n">Stream</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span><span class="mi">2</span><span class="o">,</span><span class="mi">3</span><span class="o">);</span>
<span class="n">s</span><span class="o">.</span><span class="na">count</span><span class="o">();</span>
<span class="n">s</span><span class="o">.</span><span class="na">count</span><span class="o">();</span> <span class="c1">// &lt;- error</span>
</pre></div>
</td></tr></table>

<p>In the example above, we use the <code class="codehilite">of</code> static method with a variable number of arguments to create a stream.  We can also create a stream by:</p>
<ul>
<li>converting an array to stream using <code class="codehilite">Arrays.stream</code> method</li>
<li>converting a collection to stream using <code class="codehilite">stream</code> method</li>
<li>reading from a file using <code class="codehilite">Files.lines</code> method</li>
<li>using the <code class="codehilite">generate</code> method (provide a <code class="codehilite">Supplier</code>) or <code class="codehilite">iterate</code> method (providing the initial value and incremental operation). </li>
</ul>
<p>You have seen many of the stream operations before, in Question 5 of Exercise 7, including <code class="codehilite">map</code>, <code class="codehilite">reduce</code>, <code class="codehilite">filter</code>, and <code class="codehilite">forEach</code>.  Even though they are in the context of an eagerly evaluated list, the semantics are the same.  Here are a few more useful ones.</p>
<ul>
<li><code class="codehilite">flatMap</code> is just like <code class="codehilite">map</code>, but it takes in a function that produces another stream (instead of another element), and it <code class="codehilite">flattens</code> the stream by inserting the elements from the stream produced into the stream.</li>
</ul>
<p>Let see an example.  The lambda below takes a string and return a stream of <code class="codehilite">Integer</code> objects:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="n">x</span> <span class="o">-&gt;</span> <span class="n">x</span><span class="o">.</span><span class="na">chars</span><span class="o">().</span><span class="na">boxed</span><span class="o">()</span>
</pre></div>
</td></tr></table>

<p>We can create a stream of strings using the static <code class="codehilite">of</code> method from <code class="codehilite">Stream</code>:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="n">Stream</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">&quot;live&quot;</span><span class="o">,</span> <span class="s">&quot;long&quot;</span><span class="o">,</span> <span class="s">&quot;and&quot;</span><span class="o">,</span> <span class="s">&quot;prosper&quot;</span><span class="o">)</span>
</pre></div>
</td></tr></table>

<p>If we chain the two together, using <code class="codehilite">map</code>, however, we will produce a stream of stream of <code class="codehilite">Integer</code>.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="n">Steam</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">&quot;live&quot;</span><span class="o">,</span> <span class="s">&quot;long&quot;</span><span class="o">,</span> <span class="s">&quot;and&quot;</span><span class="o">,</span> <span class="s">&quot;prosper&quot;</span><span class="o">)</span>
    <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">x</span> <span class="o">-&gt;</span> <span class="n">x</span><span class="o">.</span><span class="na">chars</span><span class="o">().</span><span class="na">boxed</span><span class="o">())</span>
</pre></div>
</td></tr></table>

<p>To produce a stream of <code class="codehilite">Integer</code>s, we use <code class="codehilite">flatMap()</code>:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="n">Stream</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">&quot;live&quot;</span><span class="o">,</span> <span class="s">&quot;long&quot;</span><span class="o">,</span> <span class="s">&quot;and&quot;</span><span class="o">,</span> <span class="s">&quot;prosper&quot;</span><span class="o">)</span>
    <span class="o">.</span><span class="na">flatMap</span><span class="o">(</span><span class="n">x</span> <span class="o">-&gt;</span> <span class="n">x</span><span class="o">.</span><span class="na">chars</span><span class="o">().</span><span class="na">boxed</span><span class="o">())</span>
</pre></div>
</td></tr></table>

<ul>
<li>
<p><code class="codehilite">sorted</code> is an intermediate operation that returns a stream with the elements in the stream sorted.  Without argument, it sorts according to the natural order.  You can also pass in a <code class="codehilite">Comparator</code> to tell <code class="codehilite">sorted</code> how to sort.</p>
</li>
<li>
<p><code class="codehilite">distinct</code> is another intermediate operation that returns a stream with only distinct elements in the stream. </p>
</li>
</ul>
<p><code class="codehilite">distinct</code> and <code class="codehilite">sorted</code> are stateful operations -- it needs to keep track of states in order to perform the operation.  <code class="codehilite">sorted</code>, in particular, needs to know every element in the stream before it can output the result.  They are also known as <code class="codehilite">bounded</code> operations, since they should only be called on a finite stream -- calling them on an infinite stream is a very bad idea.</p>
<p>Let's look at an example.  The code below shows how we can print out the unique characters of a given sequence of streams in sorted order
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="n">Stream</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">&quot;live&quot;</span><span class="o">,</span> <span class="s">&quot;long&quot;</span><span class="o">,</span> <span class="s">&quot;and&quot;</span><span class="o">,</span> <span class="s">&quot;prosper&quot;</span><span class="o">)</span>
    <span class="o">.</span><span class="na">flatMap</span><span class="o">(</span><span class="n">x</span> <span class="o">-&gt;</span> <span class="n">x</span><span class="o">.</span><span class="na">chars</span><span class="o">().</span><span class="na">boxed</span><span class="o">())</span>
    <span class="o">.</span><span class="na">distinct</span><span class="o">()</span>
    <span class="o">.</span><span class="na">sorted</span><span class="o">()</span>
    <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">Character</span><span class="o">::</span><span class="n">toChars</span><span class="o">)</span>
    <span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">::</span><span class="n">print</span><span class="o">);</span>
</pre></div>
</td></tr></table></p>
<p>There are several intermediate operations that convert from infinite stream to finite stream.  </p>
<ul>
<li><code class="codehilite">limit</code> takes in an <code class="codehilite">int</code> <span><span class="MathJax_Preview">n</span><script type="math/tex">n</script></span> and returns a stream containing the first <span><span class="MathJax_Preview">n</span><script type="math/tex">n</script></span> elements of the stream;</li>
<li><code class="codehilite">takeWhile</code> takes in a predicate and returns a stream containing the elements of the stream, until the predicate becomes false.  The resulting stream might still be infinite if the predicate never becomes false.</li>
</ul>
<p>Here are more useful terminal operations:</p>
<ul>
<li><code class="codehilite">noneMatch</code> returns true if none of the elements pass the given predicate.</li>
<li><code class="codehilite">allMatch</code> returns true if every element passes the given predicate.</li>
<li><code class="codehilite">anyMatch</code> returns true if at least one element passes the given predicate.</li>
</ul>
<p>To illustrate the use of the <code class="codehilite">Stream</code> class and its methods, let's look at an example.</p>
<h3 id="example-is-this-a-prime">Example: Is this a prime?</h3>
<p>Consider the method below, which checks if a given <code class="codehilite">int</code> is a prime:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kt">boolean</span> <span class="nf">isPrime</span><span class="o">(</span><span class="kt">int</span> <span class="n">x</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">for</span> <span class="o">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">2</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">x</span><span class="o">-</span><span class="mi">1</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">x</span> <span class="o">%</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>
  <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
</td></tr></table>

<p>The code coudln't be simpler -- or can it?  With streams, we can write it as:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kt">boolean</span> <span class="nf">isPrime</span><span class="o">(</span><span class="kt">int</span> <span class="n">x</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">return</span> <span class="n">IntStream</span><span class="o">.</span><span class="na">range</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="n">x</span><span class="o">)</span>
      <span class="o">.</span><span class="na">noneMatch</span><span class="o">(</span><span class="n">i</span> <span class="o">-&gt;</span> <span class="n">x</span> <span class="o">%</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
</td></tr></table></p>
<p><code class="codehilite">IntStream</code> is a special <code class="codehilite">Stream</code> for primitive type <code class="codehilite">int</code>, the <code class="codehilite">range(x,y)</code> method generates a stream of <code class="codehilite">int</code> from <code class="codehilite">x</code> to <code class="codehilite">y-1</code>.</p>
<p>What if we want to print out the first 500 prime numbers, starting from 2?  Normally, we would do the following:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kt">void</span> <span class="nf">fiveHundredPrime</span><span class="o">()</span> <span class="o">{</span>
  <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
  <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">2</span><span class="o">;</span>
  <span class="k">while</span> <span class="o">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">500</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">isPrime</span><span class="o">(</span><span class="n">i</span><span class="o">))</span> <span class="o">{</span>
      <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
      <span class="n">count</span><span class="o">++;</span>
    <span class="o">}</span>
    <span class="n">i</span><span class="o">++;</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</td></tr></table></p>
<p>The code is still considered simple, and understandable for many, but I am sure some of us will encounter a bug the first time we write this (either forgot to increment the counter, or put the increment in the wrong place).  If you look at the code, there are a couple of components:</p>
<ul>
<li>Lines 3 and 9 deal with iterating through different numbers for primality testing</li>
<li>Line 4 is the test</li>
<li>Lines 2, 4, and 7, deal with limiting the output to 500 primes</li>
<li>Line 5 is the action to perform on the prime</li>
</ul>
<p>With streams, we can write it like the following:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="n">IntStream</span><span class="o">.</span><span class="na">iterate</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="o">)</span>
    <span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">x</span> <span class="o">-&gt;</span> <span class="n">isPrime</span><span class="o">(</span><span class="n">x</span><span class="o">))</span>
    <span class="o">.</span><span class="na">limit</span><span class="o">(</span><span class="mi">500</span><span class="o">)</span>
    <span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">::</span><span class="n">println</span><span class="o">);</span>
</pre></div>
</td></tr></table></p>
<p>Notice how each of the four components matches neatly with one operation on stream!  </p>
<p>With stream, we no longer have to write loops, we have moved the iterations to within each operation in stream.  We no longer need to maintain states and counters, they are done within each operation as needed as well.  This has another powerful implication: our code become more <em>declarative</em>, we only need to concern about what we want at each step, much less about how to do it.</p>
<p>You should take a look at the methods provided by the <code class="codehilite">Stream</code> class, and read through the APIs, a few times, they formed the fundamental building blocks for writing functional-style data processing code in Java.</p>
<h2 id="exercise">Exercise</h2>
<ol>
<li>
<p>Write your own <code class="codehilite">Optional</code> class with the following skeleton:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kd">class</span> <span class="nc">Optional</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">{</span>
  <span class="n">T</span> <span class="n">value</span><span class="o">;</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">Optional</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="nf">of</span><span class="o">(</span><span class="n">T</span> <span class="n">v</span><span class="o">)</span> <span class="o">{</span>
    <span class="o">:</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">Optional</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="nf">ofNullable</span><span class="o">(</span><span class="n">T</span> <span class="n">v</span><span class="o">)</span> <span class="o">{</span>
    <span class="o">:</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">Optional</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="nf">empty</span><span class="o">(</span><span class="n">T</span> <span class="n">v</span><span class="o">)</span> <span class="o">{</span>
    <span class="o">:</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">ifPresent</span><span class="o">(</span><span class="n">Consumer</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="n">T</span><span class="o">&gt;</span> <span class="n">consumer</span><span class="o">)</span> <span class="o">{</span>
    <span class="o">:</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="n">Optional</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="nf">filter</span><span class="o">(</span><span class="n">Predicate</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="n">T</span><span class="o">&gt;</span> <span class="n">predicate</span><span class="o">)</span> <span class="o">{</span>
    <span class="o">:</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="o">&lt;</span><span class="n">U</span><span class="o">&gt;</span> <span class="n">Optional</span><span class="o">&lt;</span><span class="n">U</span><span class="o">&gt;</span> <span class="nf">map</span><span class="o">(</span><span class="n">Function</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="n">T</span><span class="o">,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="n">U</span><span class="o">&gt;</span> <span class="n">mapper</span><span class="o">)</span> <span class="o">{</span>
    <span class="o">:</span>
  <span class="o">}</span>

  <span class="kd">public</span><span class="o">&lt;</span><span class="n">U</span><span class="o">&gt;</span> <span class="n">Optional</span><span class="o">&lt;</span><span class="n">U</span><span class="o">&gt;</span> <span class="nf">flatMap</span><span class="o">(</span><span class="n">Function</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="n">T</span><span class="o">,</span> <span class="n">Optional</span><span class="o">&lt;</span><span class="n">U</span><span class="o">&gt;&gt;</span> <span class="n">mapper</span><span class="o">)</span> <span class="o">{</span>
    <span class="o">:</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="n">T</span> <span class="nf">orElseGet</span><span class="o">(</span><span class="n">Supplier</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">T</span><span class="o">&gt;</span> <span class="n">other</span><span class="o">)</span> <span class="o">{</span>
    <span class="o">:</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</td></tr></table>

</li>
<li>
<p>Solve each of the following with Java 9 <code class="codehilite">Stream</code>.</p>
<ul>
<li>
<p>Write a method <code class="codehilite">factors</code> with signature <code class="codehilite">LongStream factors(long x)</code> that takes in <code class="codehilite">long x</code> and return a <code class="codehilite">LongStream</code> consisting of the factors of <code class="codehilite">x</code>.  For instance, factors(6) should return the stream 1, 2, 3, 6.</p>
</li>
<li>
<p>Write a method <code class="codehilite">primeFactors</code> with signature <code class="codehilite">LongStream primeFactors(long x)</code> that takes in <code class="codehilite">long x</code> and return a <code class="codehilite">LongStream</code> consisting of the prime factors of <code class="codehilite">x</code> (a prime factor is a factor that is a prime number, excluding 1).  For instance, prime factors of 6 are 2 and 3.</p>
</li>
<li>
<p>Write a method <code class="codehilite">omega</code> with signature <code class="codehilite">LongStream omega(int n)</code> that takes in an <code class="codehilite">int n</code> and return a <code class="codehilite">LongStream</code> containing the first <span><span class="MathJax_Preview">n</span><script type="math/tex">n</script></span> <a href="https://oeis.org/A001221">omega numbers</a>.  The <span><span class="MathJax_Preview">i</span><script type="math/tex">i</script></span>-th omega number is the number of distinct prime factors for the number <span><span class="MathJax_Preview">i</span><script type="math/tex">i</script></span>.  The first 10 omega numbers are 0, 1, 1, 1, 1, 2, 1, 1, 1, 2.</p>
</li>
</ul>
</li>
<li>
<p>Write a method <code class="codehilite">product</code> that takes in two <code class="codehilite">List</code> objects <code class="codehilite">list1</code> and <code class="codehilite">list2</code>, and produce a <code class="codehilite">Stream</code> containing elements combining each element from <code class="codehilite">list1</code> with every element from <code class="codehilite">list2</code> using a given <code class="codehilite">BiFunction</code>.  This operation is similar to a Cartesian product.</p>
<p>For instance,</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">list1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
<span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">list2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
<span class="n">Collections</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">list1</span><span class="o">,</span> <span class="mi">1</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">3</span><span class="o">,</span> <span class="mi">4</span><span class="o">);</span>
<span class="n">Collections</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">list2</span><span class="o">,</span> <span class="mi">10</span><span class="o">,</span> <span class="mi">20</span><span class="o">);</span>
<span class="n">product</span><span class="o">(</span><span class="n">list1</span><span class="o">,</span> <span class="n">list2</span><span class="o">,</span> <span class="o">(</span><span class="n">str1</span><span class="o">,</span> <span class="n">str2</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">str1</span> <span class="o">+</span> <span class="n">str2</span><span class="o">)</span>
    <span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">::</span><span class="n">println</span><span class="o">);</span>
</pre></div>
</td></tr></table>

<p>gives the output:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>11
21
12
22
13
23
14
24
</pre></div>
</td></tr></table></p>
<p>The signature for <code class="codehilite">product</code> is
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>  <span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">,</span><span class="n">U</span><span class="o">,</span><span class="n">R</span><span class="o">&gt;</span> <span class="n">Stream</span><span class="o">&lt;</span><span class="n">R</span><span class="o">&gt;</span> <span class="nf">product</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">list1</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">U</span><span class="o">&gt;</span> <span class="n">list2</span><span class="o">,</span> 
      <span class="n">BiFunction</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="n">T</span><span class="o">,</span> <span class="o">?</span> <span class="kd">super</span> <span class="n">U</span><span class="o">,</span> <span class="n">R</span><span class="o">&gt;</span> <span class="n">f</span><span class="o">)</span>
</pre></div>
</td></tr></table></p>
</li>
<li>
<p>Write a method that returns the first <span><span class="MathJax_Preview">n</span><script type="math/tex">n</script></span> Fibonacci numbers as a <code class="codehilite">Stream&lt;BigInteger&gt;</code>.  For instance, the first 10 Fibonacci numbers are 1, 1, 2, 3, 5, 8, 13, 21, 34, 55.  It would be useful to write a new <code class="codehilite">Pair&lt;T, U&gt;</code> class that keeps two items around in the stream.  We use the <code class="codehilite">BigInteger</code> class to avoid overflow.</p>
</li>
</ol>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../lec07/index.html" title="7. Functions" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                7. Functions
              </span>
            </div>
          </a>
        
        
          <a href="../lec09/index.html" title="9. FP Patterns" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                9. FP Patterns
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright by Wei Tsang Ooi, Department of Computer Science, National University of Singapore 2018
          </div>
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
        
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.a59e2a89.js"></script>
      
      <script>app.initialize({version:"0.17.5",url:{base:".."}})</script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script>
      
    
    
      
    
  </body>
</html>