



<!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
        <link rel="canonical" href="https://nus-cs2030.github.io/1718-s2/lec11/index.html">
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-0.17.5, mkdocs-material-2.9.2">
    
    
      
        <title>11. Asynchronous - CS2030 Programming Methodology II</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.ba0fd1a6.css">
      
      
    
    
      <script src="../assets/javascripts/modernizr.1aa3b519.js"></script>
    
    
      <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
      
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
      <link rel="stylesheet" href="../stylesheets/extra.css">
    
      <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Gentium+Book+Basic">
    
      <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto">
    
      <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.1/css/font-awesome.min.css">
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448"
    viewBox="0 0 416 448" id="__github">
  <path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19-18.125
        8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19 18.125-8.5
        18.125 8.5 10.75 19 3.125 20.5zM320 304q0 10-3.125 20.5t-10.75
        19-18.125 8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19
        18.125-8.5 18.125 8.5 10.75 19 3.125 20.5zM360
        304q0-30-17.25-51t-46.75-21q-10.25 0-48.75 5.25-17.75 2.75-39.25
        2.75t-39.25-2.75q-38-5.25-48.75-5.25-29.5 0-46.75 21t-17.25 51q0 22 8
        38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0
        37.25-1.75t35-7.375 30.5-15 20.25-25.75 8-38.375zM416 260q0 51.75-15.25
        82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5-41.75
        1.125q-19.5 0-35.5-0.75t-36.875-3.125-38.125-7.5-34.25-12.875-30.25-20.25-21.5-28.75q-15.5-30.75-15.5-82.75
        0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25
        30.875q36.75-8.75 77.25-8.75 37 0 70 8 26.25-20.5
        46.75-30.25t47.25-9.75q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34
        99.5z" />
</svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#learning-objectives" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="https://nus-cs2030.github.io/1718-s2" title="CS2030 Programming Methodology II" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            
              <span class="md-header-nav__topic">
                CS2030 Programming Methodology II
              </span>
              <span class="md-header-nav__topic">
                11. Asynchronous
              </span>
            
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          
            <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
            
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
          
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  


  <a href="https://github.com/nus-cs2030/1718-s2/" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#__github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      GitHub
    </div>
  </a>

          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <span class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </span>
    CS2030 Programming Methodology II
  </label>
  
    <div class="md-nav__source">
      


  


  <a href="https://github.com/nus-cs2030/1718-s2/" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#__github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      GitHub
    </div>
  </a>

    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../index.html" title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      General
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        General
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../about/index.html" title="About" class="md-nav__link">
      About
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../prereqs/index.html" title="Prerequisites" class="md-nav__link">
      Prerequisites
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../policies/index.html" title="Policies" class="md-nav__link">
      Policies
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../schedule/index.html" title="Schedule" class="md-nav__link">
      Schedule
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../readings/index.html" title="Readings" class="md-nav__link">
      Readings
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../final/index.html" title="Final" class="md-nav__link">
      Final
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../midterm/index.html" title="Midterm" class="md-nav__link">
      Midterm
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7" type="checkbox" id="nav-7">
    
    <label class="md-nav__link" for="nav-7">
      Labs
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-7">
        Labs
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../lab0/index.html" title="0. Warm Up" class="md-nav__link">
      0. Warm Up
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../lab1a/index.html" title="1a. Simulator v1.0" class="md-nav__link">
      1a. Simulator v1.0
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../lab1b/index.html" title="1b. Simulator v1.1" class="md-nav__link">
      1b. Simulator v1.1
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../lab2a/index.html" title="2a. Simulator v1.2" class="md-nav__link">
      2a. Simulator v1.2
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../lab2b/index.html" title="2b. Simulator v1.3" class="md-nav__link">
      2b. Simulator v1.3
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../lab3/index.html" title="3.  Infinite List" class="md-nav__link">
      3.  Infinite List
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../lab4a/index.html" title="4a. Simulator v2.0" class="md-nav__link">
      4a. Simulator v2.0
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../lab4b/index.html" title="4b. Simulator v2.1" class="md-nav__link">
      4b. Simulator v2.1
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../lab5/index.html" title="5.  Matrix Multiplication" class="md-nav__link">
      5.  Matrix Multiplication
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../lab6/index.html" title="6.  Async Web API" class="md-nav__link">
      6.  Async Web API
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-8" type="checkbox" id="nav-8" checked>
    
    <label class="md-nav__link" for="nav-8">
      Lectures
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-8">
        Lectures
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../lec01/index.html" title="1. Abstraction & Encapsulation" class="md-nav__link">
      1. Abstraction & Encapsulation
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../lec02/index.html" title="2. Interface, Inheritance & Polymorphism" class="md-nav__link">
      2. Interface, Inheritance & Polymorphism
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../lec03/index.html" title="3. More on Inheritance" class="md-nav__link">
      3. More on Inheritance
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../lec04/index.html" title="4. Types, Memory, Exception" class="md-nav__link">
      4. Types, Memory, Exception
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../lec05/index.html" title="5. Generics and Collections" class="md-nav__link">
      5. Generics and Collections
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../lec06/index.html" title="6. hashCode, Nested Class, enum" class="md-nav__link">
      6. hashCode, Nested Class, enum
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../lec07/index.html" title="7. Functions" class="md-nav__link">
      7. Functions
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../lec08/index.html" title="8. Streams" class="md-nav__link">
      8. Streams
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../lec09/index.html" title="9. FP Patterns" class="md-nav__link">
      9. FP Patterns
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../lec10/index.html" title="10. Parallel streams" class="md-nav__link">
      10. Parallel streams
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        11. Asynchronous
      </label>
    
    <a href="index.html" title="11. Asynchronous" class="md-nav__link md-nav__link--active">
      11. Asynchronous
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#learning-objectives" title="Learning Objectives" class="md-nav__link">
    Learning Objectives
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#synchronous-vs-asynchronous" title="Synchronous vs. Asynchronous" class="md-nav__link">
    Synchronous vs. Asynchronous
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#future" title="Future" class="md-nav__link">
    Future
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#completablefuture" title="CompletableFuture" class="md-nav__link">
    CompletableFuture
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#waiting-for-completion" title="Waiting for Completion" class="md-nav__link">
    Waiting for Completion
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#completablefuture-is-a-functor-monad" title="CompletableFuture is a Functor / Monad" class="md-nav__link">
    CompletableFuture is a Functor / Monad
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#variations" title="Variations" class="md-nav__link">
    Variations
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#handling-exceptions" title="Handling Exceptions" class="md-nav__link">
    Handling Exceptions
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#exercise" title="Exercise" class="md-nav__link">
    Exercise
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../monad/index.html" title="Extra. Build a Monad" class="md-nav__link">
      Extra. Build a Monad
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../review-questions/index.html" title="Extra. Review Questions" class="md-nav__link">
      Extra. Review Questions
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../style/index.html" title="Coding Style" class="md-nav__link">
      Coding Style
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-10" type="checkbox" id="nav-10">
    
    <label class="md-nav__link" for="nav-10">
      Software/Tools
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-10">
        Software/Tools
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../jdk/index.html" title="Java" class="md-nav__link">
      Java
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../javadoc/index.html" title="Javadoc" class="md-nav__link">
      Javadoc
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../unix/index.html" title="UNIX" class="md-nav__link">
      UNIX
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../vim/index.html" title="Vim" class="md-nav__link">
      Vim
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#learning-objectives" title="Learning Objectives" class="md-nav__link">
    Learning Objectives
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#synchronous-vs-asynchronous" title="Synchronous vs. Asynchronous" class="md-nav__link">
    Synchronous vs. Asynchronous
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#future" title="Future" class="md-nav__link">
    Future
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#completablefuture" title="CompletableFuture" class="md-nav__link">
    CompletableFuture
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#waiting-for-completion" title="Waiting for Completion" class="md-nav__link">
    Waiting for Completion
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#completablefuture-is-a-functor-monad" title="CompletableFuture is a Functor / Monad" class="md-nav__link">
    CompletableFuture is a Functor / Monad
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#variations" title="Variations" class="md-nav__link">
    Variations
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#handling-exceptions" title="Handling Exceptions" class="md-nav__link">
    Handling Exceptions
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#exercise" title="Exercise" class="md-nav__link">
    Exercise
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/nus-cs2030/1718-s2/edit/master/docs/lec11.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                  <h1>11. Asynchronous</h1>
                
                <h2 id="learning-objectives">Learning Objectives</h2>
<p>After this lecture, students should:</p>
<ul>
<li>familiar with the concept of asynchronous method calls and be able to use it effectively</li>
<li>familiar with the concept of promise through Java 8 <code class="codehilite">CompletableFuture</code> class</li>
</ul>
<h2 id="synchronous-vs-asynchronous">Synchronous vs. Asynchronous</h2>
<p>In synchronous programming, when we call a method, we expect the method to be executed, and when the method returns, the result of the method is available.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kt">int</span> <span class="nf">multiply</span><span class="o">(</span><span class="kt">int</span> <span class="n">x</span><span class="o">,</span> <span class="kt">int</span> <span class="n">y</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">*</span> <span class="n">y</span><span class="o">;</span>
<span class="o">}</span>

<span class="kt">int</span> <span class="n">z</span> <span class="o">=</span> <span class="n">multiply</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="mi">4</span><span class="o">);</span>
</pre></div>
</td></tr></table>

<p>In the simple example above, our code continues executing after, and only after <code class="codehilite">multiply()</code> completes.</p>
<p>If a method takes a long time to run, however, the execution will delay the execution of subsequent methods, and maybe undesirable.</p>
<p>Asynchronous call to a method allows execution to continue immediately after calling the method, so that we can continue executing the rest of our code, while the long-running method is off doing its job.</p>
<p>You have seen examples of asynchronous calls: </p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>    <span class="n">task</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MatrixMultiplyerTask</span><span class="o">(</span><span class="n">m1</span><span class="o">,</span> <span class="n">m2</span><span class="o">);</span>
    <span class="n">task</span><span class="o">.</span><span class="na">fork</span><span class="o">();</span>
</pre></div>
</td></tr></table>

<p>The call above returns immediately even before the matrix multiplication is complete.  We can later return to this task, and call <code class="codehilite">task.join()</code> to get the result (waiting for it if necessary).  </p>
<p>A <code class="codehilite">RecursiveTask</code> also has a <code class="codehilite">isDone()</code> method that it implements as part of the <code class="codehilite">Future</code> interface.  Now, we can do something like this:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>    <span class="n">task</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MatrixMultiplyerTask</span><span class="o">(</span><span class="n">m1</span><span class="o">,</span> <span class="n">m2</span><span class="o">);</span>
    <span class="n">task</span><span class="o">.</span><span class="na">fork</span><span class="o">();</span>
    <span class="k">while</span> <span class="o">(!</span><span class="n">task</span><span class="o">.</span><span class="na">isDone</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">&quot;.&quot;</span><span class="o">);</span>
        <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">&quot;done&quot;</span><span class="o">);</span>
</pre></div>
</td></tr></table>

<p>So, while the task is running, we can print out a series of "."s to feedback to the users to indicate that it is running.</p>
<p><code class="codehilite">Thread.sleep(1000)</code> cause the current running thread to sleep for 1s.  It might throw an <code class="codehilite">InterruptedException</code>, if the user interrupts the program (by Control-C).  To complete the snippet, we should catch the exception and cancel the task. </p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>    <span class="n">task</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MatrixMultiplyerTask</span><span class="o">(</span><span class="n">m1</span><span class="o">,</span> <span class="n">m2</span><span class="o">);</span>
    <span class="n">task</span><span class="o">.</span><span class="na">fork</span><span class="o">();</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="k">while</span> <span class="o">(!</span><span class="n">task</span><span class="o">.</span><span class="na">isDone</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">&quot;.&quot;</span><span class="o">);</span>
            <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;done&quot;</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">task</span><span class="o">.</span><span class="na">cancel</span><span class="o">();</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;cancelled&quot;</span><span class="o">);</span>
    <span class="o">}</span>
</pre></div>
</td></tr></table>

<h2 id="future">Future</h2>
<p>Let's look at the <code class="codehilite">Future</code> interface a bit more.  <code class="codehilite">Future&lt;T&gt;</code> represents the result (of type <code class="codehilite">T</code>) of an asynchronous task that may not be available yet.  It has five simple operations:</p>
<ul>
<li><code class="codehilite">get()</code> returns the result of the computation (waiting for it if needed).</li>
<li><code class="codehilite">get(timeout, unit)</code> returns the result of the computation (waiting for up to the timeout period if needed).</li>
<li><code class="codehilite">cancel(interrupt)</code> tries to cancel the task -- if <code class="codehilite">interrupt</code> is true, cancel even if the task has started.  Otherwise, cancel only if the task is still waiting to get started.</li>
<li><code class="codehilite">isCancelled()</code> returns <code class="codehilite">true</code> of the task has been cancelled.</li>
<li><code class="codehilite">isDone()</code> returns <code class="codehilite">true</code> if the task has been completed.</li>
</ul>
<p>Both <code class="codehilite">RecursiveTask</code> and <code class="codehilite">RecursiveAction</code> implements the <code class="codehilite">Future</code> interface, so you can use the above methods on your tasks.</p>
<div class="admonition note">
<p class="admonition-title">In Other Languages</p>
<p>Scala's <code class="codehilite">Future</code> is more powerful -- it allows us to specify what to do when the task completes, and it hands abnormal completions (e.g., exceptions). 
    Python 3.2 supports <code class="codehilite">Future</code> through <a href="https://docs.python.org/3/library/concurrent.futures.html"><code class="codehilite">concurrent.futures</code></a> module.  C++11 supports <code class="codehilite">std::future</code>](<a href="http://en.cppreference.com/w/cpp/thread/future">http://en.cppreference.com/w/cpp/thread/future</a>) as well.</p>
</div>
<h2 id="completablefuture">CompletableFuture</h2>
<p>The example code above tries every second to see if task is done.  For some applications, the response time is critical, and we would like to know as soon as a task is done.  For instance, response time is important in stock trading applications and web services.  </p>
<p>One way to do so, is to sleep for a shorter duration.  Or even not sleeping all together:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>    <span class="n">task</span><span class="o">.</span><span class="na">fork</span><span class="o">();</span>
    <span class="k">while</span> <span class="o">(!</span><span class="n">task</span><span class="o">.</span><span class="na">isDone</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">&quot;.&quot;</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">&quot;done&quot;</span><span class="o">);</span>
</pre></div>
</td></tr></table>

<p>This is problematic in many ways, besides printing out too many dots:</p>
<ul>
<li>this is known as <em>busy waiting</em> -- and it occupies the CPU while doing nothing.  Such code should be avoided at all cost. </li>
<li>we may want to continue doing other things besides printing out "."s, so the code won't be a simple for loop anymore.  We can do something like this instead:</li>
</ul>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>    <span class="n">task</span><span class="o">.</span><span class="na">fork</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">task</span><span class="o">.</span><span class="na">isDone</span><span class="o">())</span> <span class="o">{</span>
        <span class="c1">// do something</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="n">task</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">task</span><span class="o">.</span><span class="na">isDone</span><span class="o">())</span> <span class="o">{</span>
        <span class="c1">// do something else</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="n">task</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">task</span><span class="o">.</span><span class="na">isDone</span><span class="o">())</span> <span class="o">{</span>
        <span class="c1">// do yet something else</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="n">task</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
    <span class="o">}</span>
</pre></div>
</td></tr></table>

<p>You can see that the code gets out of hand quickly, and this is only if we have one asynchronous call!</p>
<p>What we need is have a way to specify a <em>callback</em>.  A callback is basically a method that will be executed when a certain event happens.  In this case, we need to specify a callback when an asynchronous task is complete.  This way, we can just call an asynchronous task, specify what to do when the task is completed, and forget about it.  We do not need to check again and again if the task is done.</p>
<p>To do exactly this, Java 8 introduces the class <code class="codehilite">CompletableFuture&lt;V&gt;</code>, which implements the <code class="codehilite">Future&lt;V&gt;</code> interface.  Thus, just like <code class="codehilite">Future&lt;V&gt;</code>, a <code class="codehilite">CompletableFuture&lt;V&gt;</code> object returns a value of type <code class="codehilite">V</code> when it completes.  But <code class="codehilite">CompletableFuture&lt;V&gt;</code> is more powerful, it allows us to specify an asynchronous task, and an action to perform when the task completes.</p>
<p>The notion of "complete" is important for <code class="codehilite">CompletableFuture</code>.  If the <code class="codehilite">CompletableFuture</code> is complete, then the value to return is available.  We can create an already-completed <code class="codehilite">CompletableFuture</code>, passing in a value, or a yet-to-be-completed <code class="codehilite">CompletableFuture</code>, by passing in a function to be executed asynchronously.  When this function returns, the <code class="codehilite">CompletableFuture</code> completes.</p>
<p>To create a <code class="codehilite">CompletableFuture</code> object, we can call one of its static method.  For instance, <code class="codehilite">supplyAsync</code> takes in a <code class="codehilite">Supplier</code>:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="n">CompletableFuture</span><span class="o">&lt;</span><span class="n">Matrix</span><span class="o">&gt;</span> <span class="n">future</span> <span class="o">=</span> <span class="n">CompletableFuture</span><span class="o">.</span><span class="na">supplyAsync</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">m1</span><span class="o">.</span><span class="na">multiply</span><span class="o">(</span><span class="n">m2</span><span class="o">));</span>
</pre></div>
</td></tr></table>

<p>As explained above, <code class="codehilite">future</code> completes when <code class="codehilite">m1.multiply(m2)</code> returns.<br />
Let's say that we want to print out the result with a <code class="codehilite">Consumer</code> when <code class="codehilite">future</code> completes, we can use the <code class="codehilite">thenAccept</code> method:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="n">future</span><span class="o">.</span><span class="na">thenAccept</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">::</span><span class="n">println</span><span class="o">);</span>
</pre></div>
</td></tr></table>

<p>Or, you can use the oneliner:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="n">CompletableFuture</span>
    <span class="o">.</span><span class="na">supplyAsync</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">m1</span><span class="o">.</span><span class="na">multiply</span><span class="o">(</span><span class="n">m2</span><span class="o">))</span>
    <span class="o">.</span><span class="na">thenAccept</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">::</span><span class="n">println</span><span class="o">);</span>
</pre></div>
</td></tr></table>

<h3 id="waiting-for-completion">Waiting for Completion</h3>
<p>If you want your code to block until a <code class="codehilite">CompletableFuture</code> completes, you can call <code class="codehilite">join()</code>.  </p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="n">m</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
</pre></div>
</td></tr></table>

<p>Suppose you have several <code class="codehilite">CompletableFuture</code> objects, say <code class="codehilite">cf1</code>, <code class="codehilite">cf2</code>, and <code class="codehilite">cf3</code>, and you want to block until all of these <code class="codehilite">CompletableFuture</code> completes.  You can create a composite <code class="codehilite">CompletableFuture</code> objects, using <code class="codehilite">allOf()</code>:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="n">CompletableFuture</span><span class="o">.</span><span class="na">allOf</span><span class="o">(</span><span class="n">cf1</span><span class="o">,</span> <span class="n">cf2</span><span class="o">,</span> <span class="n">cf3</span><span class="o">).</span><span class="na">join</span><span class="o">();</span>
</pre></div>
</td></tr></table>

<p>The object created by <code class="codehilite">CompletableFuture.allOf(cf1, cf2, cf3)</code> completes, only after all of <code class="codehilite">cf1</code>, <code class="codehilite">cf2</code>, <code class="codehilite">cf3</code> completes.</p>
<p>There is also a <code class="codehilite">anyOf</code>, for cases where it is sufficient for any one of the <code class="codehilite">CompletableFuture</code> to complete:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="n">CompletableFuture</span><span class="o">.</span><span class="na">anyOf</span><span class="o">(</span><span class="n">cf1</span><span class="o">,</span> <span class="n">cf2</span><span class="o">,</span> <span class="n">cf3</span><span class="o">).</span><span class="na">join</span><span class="o">();</span>
</pre></div>
</td></tr></table></p>
<h3 id="completablefuture-is-a-functor-monad">CompletableFuture is a Functor / Monad</h3>
<p><code class="codehilite">CompletableFuture</code> is a functor.  Recall that a functor, in OO-speak, is a class that implements a (hypothetical) interface that looks like the following:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kd">interface</span> <span class="nc">Functor</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="o">&lt;</span><span class="n">R</span><span class="o">&gt;</span> <span class="n">Functor</span><span class="o">&lt;</span><span class="n">R</span><span class="o">&gt;</span> <span class="nf">f</span><span class="o">(</span><span class="n">Function</span><span class="o">&lt;</span><span class="n">T</span><span class="o">,</span><span class="n">R</span><span class="o">&gt;</span> <span class="n">func</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
</td></tr></table>

<p>In <code class="codehilite">CompletableFuture</code>, the method that makes <code class="codehilite">CompletableFuture</code> a functor is the <code class="codehilite">thenApply</code> method:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="o">&lt;</span><span class="nx">U</span><span class="o">&gt;</span> <span class="nx">CompletableFuture</span><span class="o">&lt;</span><span class="nx">U</span><span class="o">&gt;</span> <span class="nx">thenApply</span><span class="p">(</span><span class="nb">Function</span><span class="cp">&lt;?</span> <span class="nx">super</span> <span class="nx">T</span><span class="p">,</span><span class="o">?</span> <span class="k">extends</span> <span class="nx">U</span><span class="o">&gt;</span> <span class="nx">func</span><span class="p">)</span>
</pre></div>
</td></tr></table>

<p>The method <code class="codehilite">thenApply</code> is similar to <code class="codehilite">thenAccept</code>, except that instead of a <code class="codehilite">Consumer</code>, the callback that gets invoked when the asynchronous task completes is a `Function.  </p>
<p>There are other variations: </p>
<ul>
<li><code class="codehilite">thenRun</code>, which takes a <code class="codehilite">Runnable</code>, </li>
<li><code class="codehilite">thenAcceptBoth</code>, which takes a <code class="codehilite">BiConsumer</code> and another <code class="codehilite">CompletableFuture</code></li>
<li><code class="codehilite">thenCombine</code>, which takes a <code class="codehilite">BiFunction</code> and another <code class="codehilite">CompletableFuture</code> </li>
<li><code class="codehilite">thenCompose</code>, which takes in a <code class="codehilite">Function</code> <code class="codehilite">fn</code>, which instead of returning a "plain" type, <code class="codehilite">fn</code> returns a <code class="codehilite">CompletableFuture</code>. </li>
</ul>
<p>All the methods above return a <code class="codehilite">CompletableFuture</code>.</p>
<p>BTW, <code class="codehilite">CompletableFuture</code> is a monad too!  The <code class="codehilite">thenCompose</code> method is analougous to the <code class="codehilite">flatMap</code> method of <code class="codehilite">Stream</code> and <code class="codehilite">Optional</code>. </p>
<p>This also means that <code class="codehilite">CompletableFuture</code> satisfies the monad laws, one of which is that there is a method to wrap a value around with a <code class="codehilite">CompletableFuture</code>.  We call this the <code class="codehilite">of</code> method in the context of <code class="codehilite">Stream</code> and <code class="codehilite">Optional</code>, but in <code class="codehilite">CompletableFuture</code>, it is called <code class="codehilite">completedFuture</code>.  This method creates a <code class="codehilite">CompletableFuture</code> that is completed.
The <code class="codehilite">completedFuture</code> method is useful, for instance, if we want to convert a method below to asynchronous.
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="n">Integer</span> <span class="nf">foo</span><span class="o">(</span><span class="kt">int</span> <span class="n">x</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span> 
    <span class="k">return</span> <span class="mi">0</span><span class="o">;</span>
  <span class="k">else</span>
    <span class="k">return</span> <span class="n">doSomething</span><span class="o">(</span><span class="n">x</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
</td></tr></table></p>
<p>With <code class="codehilite">CompletableFuture</code>, it becomes:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="n">CompletableFuture</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="nf">fooAsync</span><span class="o">(</span><span class="kt">int</span> <span class="n">x</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span> 
    <span class="k">return</span> <span class="n">CompletableFuture</span><span class="o">.</span><span class="na">completedFuture</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
  <span class="k">else</span> 
    <span class="k">return</span> <span class="n">CompletableFuture</span><span class="o">.</span><span class="na">supplyAsync</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">doSomething</span><span class="o">(</span><span class="n">x</span><span class="o">));</span>
</pre></div>
</td></tr></table></p>
<div class="admonition note">
<p class="admonition-title">Extra Example</p>
<p>In the class, I got carried away with the question about <code class="codehilite">completedFuture</code> and added the following example for <s><code class="codehilite">flatMap</code></s> <code class="codehilite">thenCompose</code> as well:</p>
<p>Original non-async version:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="n">bar</span><span class="o">(</span><span class="n">z</span><span class="o">)</span>
<span class="kt">int</span> <span class="n">y</span> <span class="o">=</span> <span class="n">foo</span><span class="o">(</span><span class="n">x</span><span class="o">)</span>
</pre></div>
</td></tr></table></p>
<p>Async version:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="n">y</span> <span class="o">=</span> <span class="n">barAsync</span><span class="o">(</span><span class="n">z</span><span class="o">)</span>
       <span class="o">.</span><span class="na">thenCompose</span><span class="o">(</span><span class="n">i</span> <span class="o">-&gt;</span> <span class="n">fooAsync</span><span class="o">(</span><span class="n">i</span><span class="o">))</span>
       <span class="o">.</span><span class="na">get</span><span class="o">();</span>
</pre></div>
</td></tr></table></p>
</div>
<p>When we discussed about monad, we say that one way to think of a monad as a wrapper of a value in some context.  In the case of <code class="codehilite">Optional</code>, the context is that the value may or may not be there.  In the context of <code class="codehilite">CompletableFuture</code>, the context is that the value not be available yet.</p>
<p>Being a functor and a monad, <code class="codehilite">CompletableFuture</code> objects can be chained together, just like <code class="codehilite">Stream</code> and <code class="codehilite">Optional</code>.  We can write code like this:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="n">CompletableFuture</span>
    <span class="o">.</span><span class="na">completedFuture</span><span class="o">(</span><span class="n">Matrix</span><span class="o">.</span><span class="na">generate</span><span class="o">(</span><span class="n">nRows</span><span class="o">,</span> <span class="n">nCols</span><span class="o">,</span> <span class="n">rng</span><span class="o">::</span><span class="n">nextDouble</span><span class="o">))</span>
    <span class="o">.</span><span class="na">thenApply</span><span class="o">(</span><span class="n">m</span> <span class="o">-&gt;</span> <span class="n">m</span><span class="o">.</span><span class="na">multiply</span><span class="o">(</span><span class="n">m1</span><span class="o">))</span>
    <span class="o">.</span><span class="na">thenApply</span><span class="o">(</span><span class="n">m</span> <span class="o">-&gt;</span> <span class="n">m</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">m2</span><span class="o">))</span>
    <span class="o">.</span><span class="na">thenApply</span><span class="o">(</span><span class="n">m</span> <span class="o">-&gt;</span> <span class="n">m</span><span class="o">.</span><span class="na">transpose</span><span class="o">)</span>
    <span class="o">.</span><span class="na">thenAccept</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">::</span><span class="n">println</span><span class="o">);</span>
</pre></div>
</td></tr></table>

<p>Another example:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="n">CompletableFuture</span> <span class="n">left</span> <span class="o">=</span> <span class="n">CompletableFuture</span>
    <span class="o">.</span><span class="na">supplyAsync</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">a1</span><span class="o">.</span><span class="na">multiply</span><span class="o">(</span><span class="n">b1</span><span class="o">));</span>
<span class="n">CompletableFuture</span> <span class="n">right</span> <span class="o">=</span> <span class="n">CompletableFuture</span>
    <span class="o">.</span><span class="na">supplyAsync</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">a2</span><span class="o">.</span><span class="na">multiply</span><span class="o">(</span><span class="n">b2</span><span class="o">))</span>
    <span class="o">.</span><span class="na">thenCombine</span><span class="o">(</span><span class="n">left</span><span class="o">,</span> <span class="o">(</span><span class="n">m1</span><span class="o">,</span> <span class="n">m2</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">m1</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">m2</span><span class="o">));</span>
    <span class="o">.</span><span class="na">thenAccept</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">::</span><span class="n">println</span><span class="o">);</span>
</pre></div>
</td></tr></table>

<p>Similar to <code class="codehilite">Stream</code>, some of the methods are terminal (e.g., <code class="codehilite">thenRun</code>, <code class="codehilite">thenAccept</code>), and some are intermediate (<code class="codehilite">thenApply</code>).</p>
<h3 id="variations">Variations</h3>
<ul>
<li>
<p>There are variations of methods with name containing the word <code class="codehilite">Either</code> or <code class="codehilite">Both</code>, taking in another <code class="codehilite">CompletableFuture</code>.  These methods invoke the given <code class="codehilite">Function</code>/<code class="codehilite">Runnable</code>/<code class="codehilite">Consumer</code> when either one (for <code class="codehilite">Either</code>) or both (for <code class="codehilite">Both</code>) of the <code class="codehilite">CompletableFuture</code> completes.</p>
</li>
<li>
<p>There are variations of methods with name ending with the word <code class="codehilite">Async</code>.  These methods are called asynchronously in another thread</p>
</li>
</ul>
<p>For example, <code class="codehilite">runAfterBothAsync(future, task)</code> would run <code class="codehilite">task</code> only after <code class="codehilite">this</code> and given <code class="codehilite">future</code> is completed.</p>
<p>Other features of <code class="codehilite">CompletableFuture</code> include:</p>
<ul>
<li>
<p>Some methods take in additional <code class="codehilite">Executor</code> parameter, for cases where running in the default <code class="codehilite">ForkJoinPool</code> is not good enough.</p>
</li>
<li>
<p>Some methods takes in additional <code class="codehilite">Throwable</code> parameter, for cases where earlier calls might throw an exception.</p>
</li>
</ul>
<h3 id="handling-exceptions">Handling Exceptions</h3>
<p>Handling exceptions is non-trivial for asynchronous methods.  Remember that, in synchronous method calls, the exceptions are repeatedly thrown to the caller up the call stack, until someone catches the exception.  For asynchronous calls, it is not so obvious.  For instance, should we put a catch around <code class="codehilite">fork()</code> or around <code class="codehilite">join()</code>?  A <code class="codehilite">ForkJoinTask</code> doesn't handle exception with catch, but instead requires us to check for <code class="codehilite">isCompletedAbnormally</code> and then call <code class="codehilite">getException</code> to get the exception thrown.</p>
<p>As <code class="codehilite">CompletableFuture</code> allows chaining, it provides a cleaner way to pass exceptions from one call to the next.  The terminal operation <code class="codehilite">whenComplete</code> takes in a <code class="codehilite">BiConsumer</code> as parameter -- the first argument to the <code class="codehilite">BiConsumer</code> is the result from previous chain (or <code class="codehilite">null</code> if exception thrown); the second argument is an exception (null if completes normally).</p>
<p><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="n">CompletableFuture</span>
    <span class="o">.</span><span class="na">completedFuture</span><span class="o">(</span><span class="n">Matrix</span><span class="o">.</span><span class="na">generate</span><span class="o">(</span><span class="n">nRows</span><span class="o">,</span> <span class="n">nCols</span><span class="o">,</span> <span class="n">rng</span><span class="o">::</span><span class="n">nextDouble</span><span class="o">))</span>
    <span class="o">.</span><span class="na">thenApply</span><span class="o">(</span><span class="n">m</span> <span class="o">-&gt;</span> <span class="n">m</span><span class="o">.</span><span class="na">multiply</span><span class="o">(</span><span class="n">m</span><span class="o">))</span>
    <span class="o">.</span><span class="na">whenComplete</span><span class="o">((</span><span class="n">result</span><span class="o">,</span> <span class="n">exception</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">exception</span><span class="o">)</span> <span class="o">{</span> 
            <span class="n">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">exception</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="n">result</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
</pre></div>
</td></tr></table>
<code class="codehilite">whenComplete</code> returns a CompletableFuture, surprisingly, despite it taking in a <code class="codehilite">BiConsumer</code> -- in a sense, <code class="codehilite">whenComplete</code> is more similar to <code class="codehilite">peek</code> rather than <code class="codehilite">forEach</code>.</p>
<p><code class="codehilite">handle</code> is similar to <code class="codehilite">whenComplete</code>, but takes in a <code class="codehilite">BiFunction</code> instead of a <code class="codehilite">BiConsumer</code>, thus allowing the result or exception to be transformed. </p>
<p>Finally, <code class="codehilite">exceptionally</code> handles exception by replacing a thrown exception with a value, similar to <code class="codehilite">orElse</code> in <code class="codehilite">Optional</code>.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="n">CompletableFuture</span>
    <span class="o">.</span><span class="na">completedFuture</span><span class="o">(</span><span class="n">Matrix</span><span class="o">.</span><span class="na">generate</span><span class="o">(</span><span class="n">nRows</span><span class="o">,</span> <span class="n">nCols</span><span class="o">,</span> <span class="n">rng</span><span class="o">::</span><span class="n">nextDouble</span><span class="o">))</span>
    <span class="o">.</span><span class="na">thenApply</span><span class="o">(</span><span class="n">m</span> <span class="o">-&gt;</span> <span class="n">m</span><span class="o">.</span><span class="na">multiply</span><span class="o">(</span><span class="n">m</span><span class="o">))</span>
    <span class="o">.</span><span class="na">exceptionally</span><span class="o">(</span><span class="n">ex</span> <span class="o">-&gt;</span> <span class="n">Matrix</span><span class="o">.</span><span class="na">generate</span><span class="o">(</span><span class="n">nRows</span><span class="o">,</span> <span class="n">nCols</span><span class="o">,</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="mi">0</span><span class="o">));</span>
</pre></div>
</td></tr></table>

<div class="admonition note">
<p class="admonition-title">Promise</p>
<p><code class="codehilite">CompletableFuture</code> is similar to <code class="codehilite">Promise</code> in other languages, notably JavaScript and C++ (<code class="codehilite">std::promise</code>).</p>
</div>
<div class="admonition note">
<p class="admonition-title">CompletionStage</p>
<p>In Java, <code class="codehilite">CompletableFuture</code> also implements a <code class="codehilite">CompletionStage</code> interface.  Thus, you will find references to this interface in many places in the Java documentation.  I find this name unintuitive and makes an already-confusing java documentation even harder to read.</p>
</div>
<h2 id="exercise">Exercise</h2>
<ol>
<li>
<p>Change the following sequence of code so that <code class="codehilite">f()</code>, <code class="codehilite">g()</code> and <code class="codehilite">h()</code> are invoked asynchronously, using <code class="codehilite">CompletableFuture</code>.</p>
<p>(i)
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="n">B</span> <span class="n">b</span> <span class="o">=</span> <span class="n">f</span><span class="o">(</span><span class="n">a</span><span class="o">);</span>
<span class="n">C</span> <span class="n">c</span> <span class="o">=</span> <span class="n">g</span><span class="o">(</span><span class="n">b</span><span class="o">);</span>
<span class="n">D</span> <span class="n">d</span> <span class="o">=</span> <span class="n">h</span><span class="o">(</span><span class="n">c</span><span class="o">);</span>
</pre></div>
</td></tr></table></p>
<p>(ii)
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="n">B</span> <span class="n">b</span> <span class="o">=</span> <span class="n">f</span><span class="o">();</span>
<span class="n">C</span> <span class="n">c</span> <span class="o">=</span> <span class="n">g</span><span class="o">(</span><span class="n">b</span><span class="o">);</span>
<span class="n">h</span><span class="o">(</span><span class="n">c</span><span class="o">);</span> <span class="c1">// no return value</span>
</pre></div>
</td></tr></table></p>
<p>(iii)
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="n">B</span> <span class="n">b</span> <span class="o">=</span> <span class="n">f</span><span class="o">(</span><span class="n">a</span><span class="o">);</span>
<span class="n">C</span> <span class="n">c</span> <span class="o">=</span> <span class="n">g</span><span class="o">(</span><span class="n">b</span><span class="o">);</span>
<span class="n">D</span> <span class="n">d</span> <span class="o">=</span> <span class="n">h</span><span class="o">(</span><span class="n">b</span><span class="o">);</span>
<span class="n">E</span> <span class="n">e</span> <span class="o">=</span> <span class="n">i</span><span class="o">(</span><span class="n">c</span><span class="o">,</span> <span class="n">d</span><span class="o">);</span>
</pre></div>
</td></tr></table></p>
</li>
</ol>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../lec10/index.html" title="10. Parallel streams" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                10. Parallel streams
              </span>
            </div>
          </a>
        
        
          <a href="../monad/index.html" title="Extra. Build a Monad" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Extra. Build a Monad
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright by Wei Tsang Ooi, Department of Computer Science, National University of Singapore 2018
          </div>
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
        
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.a59e2a89.js"></script>
      
      <script>app.initialize({version:"0.17.5",url:{base:".."}})</script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script>
      
    
    
      
    
  </body>
</html>